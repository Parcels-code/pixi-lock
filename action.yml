name: Create Pixi Lock
description: Generate and cache a pixi.lock file, restoring from cache when available

inputs:
  pixi-version:
    description: "Version of pixi to use for generating the lock file"
    required: false
    default: "latest"

runs:
  using: "composite"
  steps:
    - name: Get current date
      id: date
      shell: bash
      run: echo "date=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

    - name: Restore pixi.lock from cache
      uses: actions/cache/restore@v5
      id: restore
      with:
        path: pixi.lock
        key: ${{ steps.date.outputs.date }}_${{ inputs.pixi-version }}_${{ hashFiles('pixi.toml') }}

    - name: Setup pixi
      uses: prefix-dev/setup-pixi@v0.9.3
      if: ${{ !steps.restore.outputs.cache-hit }}
      with:
        pixi-version: ${{ inputs.pixi-version }}
        run-install: false

    - name: Run pixi lock
      if: ${{ !steps.restore.outputs.cache-hit }}
      shell: bash
      run: pixi lock

    - name: Save pixi.lock to cache
      uses: actions/cache/save@v5
      if: ${{ !steps.restore.outputs.cache-hit }}
      with:
        path: pixi.lock
        key: ${{ steps.date.outputs.date }}_${{ inputs.pixi-version }}_${{ hashFiles('pixi.toml') }}
